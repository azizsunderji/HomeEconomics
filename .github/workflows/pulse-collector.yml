name: Pulse Collector

on:
  schedule:
    # 4x daily: 6am, 12pm, 6pm, 11pm ET
    # EDT (UTC-4)
    - cron: "0 10 * * *"   # 6am ET during EDT
    - cron: "0 16 * * *"   # 12pm ET during EDT
    - cron: "0 22 * * *"   # 6pm ET during EDT
    - cron: "0 3 * * *"    # 11pm ET during EDT
    # EST (UTC-5)
    - cron: "0 11 * * *"   # 6am ET during EST
    - cron: "0 17 * * *"   # 12pm ET during EST
    - cron: "0 23 * * *"   # 6pm ET during EST
    - cron: "0 4 * * *"    # 11pm ET during EST
  workflow_dispatch:
    inputs:
      sources:
        description: "Specific sources to collect (comma-separated, blank = all)"
        required: false
        default: ""

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      APIFY_API_KEY: ${{ secrets.APIFY_API_KEY }}
      GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
      GMAIL_TOKENS: ${{ secrets.GMAIL_TOKENS }}
      BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
      BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r pulse/requirements.txt

      - name: Install rclone
        run: sudo apt-get update && sudo apt-get install -y rclone

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << 'EOF'
          [dropbox]
          type = dropbox
          token = ${{ secrets.RCLONE_DROPBOX_TOKEN }}
          EOF

      - name: Pull existing Pulse DB from Dropbox
        run: |
          mkdir -p pulse/data
          rclone copy "dropbox:Home Economics/Data/Pulse/pulse.db" pulse/data/ \
            --verbose --stats-one-line || echo "No existing DB found â€” starting fresh"

      - name: Run collector + classifier
        working-directory: pulse/scripts
        run: |
          if [ -n "${{ github.event.inputs.sources }}" ]; then
            python run_pipeline.py collect --sources ${{ github.event.inputs.sources }}
          else
            python run_pipeline.py collect
          fi

      - name: Sync DB back to Dropbox
        if: always()
        run: |
          rclone copy pulse/data/pulse.db "dropbox:Home Economics/Data/Pulse/" \
            --verbose --stats-one-line
