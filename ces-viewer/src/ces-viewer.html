<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CES Employment Data Viewer</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
    <style>
        @font-face {
            font-family: 'Oracle';
            src: url('/fonts/Oracle-Regular.woff2') format('woff2'),
                 url('/fonts/Oracle-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Oracle';
            src: url('/fonts/Oracle-Bold.woff2') format('woff2'),
                 url('/fonts/Oracle-Bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
        }
        
        body {
            font-family: 'Oracle', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #F6F7F3;
            color: #3D3733;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 600px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            border-right: 1px solid #DADFCE;
        }
        
        .main {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        h1 {
            margin: 0 0 15px 0;
            font-size: 22px;
            color: #3D3733;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-size: 12px;
            color: #3D3733;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, button {
            padding: 8px 12px;
            border: 1px solid #DADFCE;
            border-radius: 4px;
            background: white;
            color: #3D3733;
            font-size: 14px;
            cursor: pointer;
        }
        
        select:hover, button:hover {
            border-color: #67A275;
        }
        
        button {
            background: #67A275;
            color: white;
            border: none;
            font-weight: 500;
        }
        
        button:hover {
            background: #5A8F66;
        }
        
        /* Tree styling */
        .tree-item {
            margin: 2px 0;
            line-height: 1.6;
        }
        
        .tree-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #3D3733;
            text-transform: none;
            letter-spacing: normal;
            white-space: nowrap;
        }
        
        .tree-item label:hover {
            background: rgba(103, 162, 117, 0.1);
        }
        
        .tree-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .tree-item .toggle {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #3D3733;
            user-select: none;
            flex-shrink: 0;
            font-family: monospace;
        }
        
        .tree-item .toggle:hover {
            background: rgba(103, 162, 117, 0.15);
            border-radius: 2px;
            color: #67A275;
        }
        
        .tree-item .toggle.empty {
            visibility: hidden;
        }
        
        .tree-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Depth-based indentation for proper tree structure */
        .depth-0 { padding-left: 12px !important; }
        .depth-1 { padding-left: 30px !important; }
        .depth-2 { padding-left: 50px !important; }
        .depth-3 { padding-left: 70px !important; }
        .depth-4 { padding-left: 90px !important; }
        .depth-5 { padding-left: 110px !important; }
        .depth-6 { padding-left: 130px !important; }
        .depth-7 { padding-left: 150px !important; }
        
        .select-children {
            padding: 4px 8px;
            margin: 0 4px;
            background: #0BB4FF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .select-children:hover {
            background: #0A99DB;
        }
        
        .tree-item .value {
            font-size: 11px;
            color: #3D3733;
            margin-left: auto;
            padding-left: 10px;
            font-weight: 500;
        }
        
        .tree-children {
            display: none;
        }
        
        .tree-children.expanded {
            display: block;
        }
        
        /* Hierarchy levels with background shading using brand colors */
        .level-total {
            font-weight: bold;
            font-size: 16px;
            background: #0BB4FF;
            color: white;
            margin: 10px 0;
            border-radius: 4px;
            padding-left: 12px !important;
        }
        
        .level-total .value { color: rgba(255,255,255,0.8); }
        .level-total label { color: white; }
        
        .level-major {
            font-weight: 600;
            font-size: 14px;
            background: #FEC439;
            margin-left: 0;
            margin-top: 8px;
            padding-left: 20px !important;
            color: #3D3733;
            border-radius: 3px;
        }
        
        .level-major label { color: #3D3733; }
        
        .level-supersector {
            font-weight: 500;
            font-size: 13px;
            background: #C6DCCB;
            margin-left: 0;
            margin-top: 6px;
            padding-left: 30px !important;
            color: #3D3733;
            border-radius: 2px;
        }
        
        .level-sector {
            font-weight: normal;
            font-size: 12px;
            margin-left: 0;
            padding-left: 40px !important;
            background: #F6F7F3;
            color: #3D3733;
            border-radius: 2px;
            border-left: 3px solid #67A275;
        }
        
        .level-subsector {
            margin-left: 0;
            padding-left: 50px !important;
            font-size: 11px;
            color: #3D3733;
            background: rgba(218, 223, 206, 0.15);
            border-radius: 2px;
        }
        
        .level-industry_group {
            margin-left: 0;
            padding-left: 60px !important;
            font-size: 10px;
            color: #3D3733;
            background: rgba(246, 247, 243, 0.5);
        }
        
        .level-industry {
            margin-left: 0;
            padding-left: 70px !important;
            font-size: 10px;
            color: #3D3733;
            opacity: 0.9;
        }
        
        #chart {
            flex: 1;
            min-height: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #3D3733;
        }
        
        .error {
            color: #F4743B;
            padding: 20px;
            background: #FBCAB5;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .status {
            font-size: 12px;
            color: #3D3733;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Employment Data</h1>
            <div class="status" id="status">Loading...</div>
            <div style="margin: 10px 0;">
                <button id="expandAll" style="margin-right: 5px; padding: 5px 10px; font-size: 12px;">Expand All</button>
                <button id="collapseAll" style="padding: 5px 10px; font-size: 12px;">Collapse All</button>
            </div>
            <div id="hierarchy">
                <div class="loading">Loading data...</div>
            </div>
        </div>
        
        <div class="main">
            <div class="controls">
                <div class="control-group">
                    <label>View</label>
                    <select id="viewType">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="annual">Annual</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Data Type</label>
                    <select id="dataType">
                        <option value="level">Levels</option>
                        <option value="mom" class="monthly-only">Month-over-month change</option>
                        <option value="m3m" class="monthly-only">3-Month Change</option>
                        <option value="yoy" class="monthly-only">Year-over-year change</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Date Range</label>
                    <select id="dateRange">
                        <option value="1">1 year</option>
                        <option value="1.5">18 months</option>
                        <option value="2">2 years</option>
                        <option value="3" selected>3 years</option>
                        <option value="5">5 years</option>
                        <option value="10">10 years</option>
                        <option value="all">All available</option>
                    </select>
                </div>
                
                <button id="clearAll">Clear All</button>
                <button id="selectMajor">Major Sectors</button>
            </div>
            
            <div id="chart"></div>
        </div>
    </div>

    <script>
        // Configuration with aggressive cache-busting
        const CACHE_BUST = Date.now();
        const DATA_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? '../data/ces_data.json'
            : `./ces_data.json?nocache=${CACHE_BUST}&t=${Math.random()}`;
        
        // Brand colors
        const COLORS = [
            '#0BB4FF', '#FEC439', '#67A275', '#F4743B',
            '#C6DCCB', '#FBCAB5', '#DADFCE', '#3D3733'
        ];
        
        // State management
        let cesData = null;
        let seriesById = {};
        let selectedSeries = new Set();
        let currentView = 'monthly';
        let currentDataType = 'level';
        let currentDateRange = 3;
        
        // Load data on startup
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error('Failed to load data');
                
                cesData = await response.json();
                
                // Create lookup map
                cesData.series.forEach(s => {
                    seriesById[s.id] = s;
                });
                
                document.getElementById('status').textContent = 
                    `${cesData.meta.series_count} series • ${cesData.meta.start_date} to ${cesData.meta.end_date}`;
                
                buildHierarchy();
                updateChart();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('hierarchy').innerHTML = 
                    `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }
        
        function buildHierarchy() {
            if (!cesData) return;
            
            const container = document.getElementById('hierarchy');
            container.innerHTML = '';
            
            // Build tree structure
            const tree = {};
            const roots = [];
            
            // First pass: identify roots and build parent map
            cesData.series.forEach(series => {
                if (!series.parent) {
                    roots.push(series);
                } else {
                    if (!tree[series.parent]) {
                        tree[series.parent] = [];
                    }
                    tree[series.parent].push(series);
                }
            });
            
            // Sort roots
            roots.sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Recursive function to build tree UI
            function buildTreeNode(series, container, startExpanded = false, depth = 0) {
                const div = document.createElement('div');
                div.className = `tree-item level-${series.level} depth-${depth}`;
                
                const label = document.createElement('label');
                
                // Check if this node has children
                const children = tree[series.id];
                const hasChildren = children && children.length > 0;
                
                // Add toggle button with better arrows
                const toggle = document.createElement('span');
                toggle.className = hasChildren ? 'toggle' : 'toggle empty';
                toggle.innerHTML = hasChildren ? '&#9654;' : ''; // Right-pointing triangle
                if (hasChildren) {
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const childrenDiv = div.querySelector('.tree-children');
                        if (childrenDiv) {
                            const isExpanded = childrenDiv.classList.toggle('expanded');
                            toggle.innerHTML = isExpanded ? '&#9660;' : '&#9654;'; // Down or right triangle
                        }
                    });
                }
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = series.id;
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    
                    if (e.target.checked) {
                        // Just select this series only
                        selectedSeries.add(series.id);
                    } else {
                        // Uncheck this series only
                        selectedSeries.delete(series.id);
                    }
                    updateChart();
                });
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // Add "select all children" button for items with children
                let selectChildrenBtn = null;
                if (hasChildren) {
                    selectChildrenBtn = document.createElement('button');
                    selectChildrenBtn.className = 'select-children';
                    selectChildrenBtn.innerHTML = 'All';
                    selectChildrenBtn.title = 'Select all children';
                    selectChildrenBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        // Get only immediate children (not all descendants)
                        const immediateChildren = tree[series.id] || [];
                        
                        // Check if all immediate children are selected
                        const allChecked = immediateChildren.every(child => selectedSeries.has(child.id));
                        
                        if (allChecked) {
                            // Uncheck all immediate children
                            immediateChildren.forEach(child => {
                                selectedSeries.delete(child.id);
                                const childCheckbox = document.querySelector(`input[value="${child.id}"]`);
                                if (childCheckbox) childCheckbox.checked = false;
                            });
                        } else {
                            // Check all immediate children
                            immediateChildren.forEach(child => {
                                selectedSeries.add(child.id);
                                const childCheckbox = document.querySelector(`input[value="${child.id}"]`);
                                if (childCheckbox) childCheckbox.checked = true;
                            });
                        }
                        
                        // Make sure parent checkbox reflects state
                        checkbox.checked = false; // Parent itself is not selected when children are
                        updateChart();
                    });
                }
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.textContent = series.name;
                
                // Get latest value
                const dates = Object.keys(series.data).sort();
                const valueSpan = document.createElement('span');
                valueSpan.className = 'value';
                if (dates.length > 0) {
                    const latestValue = series.data[dates[dates.length - 1]];
                    valueSpan.textContent = formatNumber(latestValue);
                }
                
                label.appendChild(toggle);
                label.appendChild(checkbox);
                if (selectChildrenBtn) {
                    label.appendChild(selectChildrenBtn);
                }
                label.appendChild(nameSpan);
                label.appendChild(valueSpan);
                
                // Clicking on label (but not checkbox or toggle) toggles expansion
                label.addEventListener('click', (e) => {
                    if (e.target === checkbox || e.target === toggle) return;
                    e.preventDefault();
                    if (hasChildren) {
                        toggle.click();
                    }
                });
                
                div.appendChild(label);
                
                // Add children in collapsible container
                if (hasChildren) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = startExpanded ? 'tree-children expanded' : 'tree-children';
                    
                    children.sort((a, b) => (a.order || 999) - (b.order || 999));
                    children.forEach(child => {
                        // Don't auto-expand children
                        buildTreeNode(child, childrenDiv, false, depth + 1);
                    });
                    
                    div.appendChild(childrenDiv);
                    
                    // Update toggle icon if expanded
                    if (startExpanded) {
                        toggle.innerHTML = '&#9660;'; // Down triangle
                    }
                }
                
                container.appendChild(div);
            }
            
            // Build the tree starting from roots, collapsed by default
            roots.forEach(root => {
                buildTreeNode(root, container, false, 0);
            });
        }
        
        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toFixed(0);
        }
        
        function getFilteredDates() {
            if (!cesData) return [];
            
            // Get all dates from first series with data
            const seriesWithData = cesData.series.find(s => s.data && Object.keys(s.data).length > 0);
            if (!seriesWithData) return [];
            
            const allDates = Object.keys(seriesWithData.data).sort();
            
            if (currentDateRange === 'all') {
                return allDates;
            }
            
            const cutoffDate = new Date();
            cutoffDate.setFullYear(cutoffDate.getFullYear() - parseFloat(currentDateRange));
            
            return allDates.filter(date => new Date(date) >= cutoffDate);
        }
        
        let isolatedSeries = null; // Track which series is isolated
        let originalSelectedSeries = new Set(); // Store original selection
        
        function updateChart() {
            if (!cesData || selectedSeries.size === 0) {
                document.getElementById('chart').innerHTML = 
                    '<div class="loading">Select series to display</div>';
                return;
            }
            
            let filteredDates = getFilteredDates();
            
            // Find the last date where all selected series have data
            const lastValidDate = filteredDates.reduce((lastDate, date) => {
                const allHaveData = Array.from(selectedSeries).every(seriesId => {
                    const series = seriesById[seriesId];
                    return series && series.data && series.data[date] != null && series.data[date] !== 0;
                });
                return allHaveData ? date : lastDate;
            }, null);
            
            // Filter dates to only include up to the last valid date
            if (lastValidDate) {
                filteredDates = filteredDates.filter(date => date <= lastValidDate);
            }
            
            const traces = [];
            const seriesArray = Array.from(selectedSeries);
            
            seriesArray.forEach((seriesId, index) => {
                const series = seriesById[seriesId];
                if (!series || !series.data) return;
                
                // Get data for filtered dates
                const values = filteredDates.map(d => series.data[d] || 0);
                
                // Transform based on view and data type
                let x = filteredDates;
                let y = values;
                
                // Handle different data types (absolute changes vs levels)
                if (currentDataType === 'mom') {
                    // Month-over-month absolute change
                    y = values.map((val, i) => {
                        if (i === 0) return null;
                        // Check if both current and previous values exist
                        if (val === 0 || values[i - 1] === 0) return null;
                        return val - values[i - 1];
                    });
                } else if (currentDataType === 'm3m') {
                    // 3-month absolute change
                    y = values.map((val, i) => {
                        if (i < 3) return null;
                        // Check if both current and 3-month-ago values exist
                        if (val === 0 || values[i - 3] === 0) return null;
                        return val - values[i - 3];
                    });
                } else if (currentDataType === 'yoy') {
                    // Year-over-year absolute change
                    y = values.map((val, i) => {
                        if (i < 12) return null;
                        // Check if both current and year-ago values exist
                        if (val === 0 || values[i - 12] === 0) return null;
                        return val - values[i - 12];
                    });
                }
                
                if (currentView === 'quarterly') {
                    // Aggregate by quarter
                    const quarterData = {};
                    filteredDates.forEach((date, i) => {
                        const year = date.substring(0, 4);
                        const month = parseInt(date.substring(5, 7));
                        const quarter = Math.ceil(month / 3);
                        const quarterKey = `${year}-Q${quarter}`;
                        if (!quarterData[quarterKey]) quarterData[quarterKey] = [];
                        if (y[i] !== null && y[i] !== undefined) quarterData[quarterKey].push(y[i]);
                    });
                    x = Object.keys(quarterData).sort();
                    y = x.map(quarter => {
                        const vals = quarterData[quarter];
                        return vals.length > 0 ? vals.reduce((a, b) => a + b) / vals.length : 0;
                    });
                } else if (currentView === 'annual') {
                    // Aggregate by year
                    const yearData = {};
                    filteredDates.forEach((date, i) => {
                        const year = date.substring(0, 4);
                        if (!yearData[year]) yearData[year] = [];
                        if (y[i] !== null && y[i] !== undefined) yearData[year].push(y[i]);
                    });
                    x = Object.keys(yearData).sort();
                    y = x.map(year => {
                        const vals = yearData[year];
                        return vals.length > 0 ? vals.reduce((a, b) => a + b) / vals.length : 0;
                    });
                }
                
                traces.push({
                    x: x,
                    y: y,
                    name: series.name,
                    type: 'bar',
                    marker: { 
                        color: isolatedSeries && seriesId !== isolatedSeries ? '#E0E0E0' : COLORS[index % COLORS.length] 
                    },
                    hovertemplate: '<b>%{data.name}</b><br>' +
                                   '%{x|%b %Y}<br>' +
                                   'Value: %{y:,.0f}<extra></extra>'
                });
            });
            
            // Update y-axis label based on data type
            let yAxisTitle = 'Employment (thousands)';
            if (currentDataType === 'mom') {
                yAxisTitle = 'Month-over-Month Change (thousands)';
            } else if (currentDataType === 'm3m') {
                yAxisTitle = '3-Month Change (thousands)';
            } else if (currentDataType === 'yoy') {
                yAxisTitle = 'Year-over-Year Change (thousands)';
            }
            
            const layout = {
                barmode: 'stack',
                title: '',
                xaxis: {
                    title: '',
                    tickangle: -45
                },
                yaxis: {
                    title: yAxisTitle,
                    tickformat: ',.0f'
                },
                margin: { t: 40, r: 40, b: 100, l: 80 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: 1.15,
                    x: 0
                },
                paper_bgcolor: 'white',
                plot_bgcolor: 'white'
            };
            
            const config = {
                responsive: true,
                displayModeBar: false  // Hide the Plotly toolbar
            };
            
            Plotly.newPlot('chart', traces, layout, config);
            
            // Handle double-click on legend to isolate/reset series using Plotly's built-in behavior
            const chartDiv = document.getElementById('chart');
            chartDiv.on('plotly_legenddoubleclick', function(eventData) {
                // Use Plotly's built-in 'toggleothers' behavior
                return 'toggleothers';
            });
        }
        
        // Event listeners
        document.getElementById('viewType').addEventListener('change', (e) => {
            currentView = e.target.value;
            updateChart();
        });
        
        document.getElementById('dataType').addEventListener('change', (e) => {
            currentDataType = e.target.value;
            updateChart();
        });
        
        document.getElementById('dateRange').addEventListener('change', (e) => {
            currentDateRange = e.target.value;
            updateChart();
        });
        
        document.getElementById('clearAll').addEventListener('click', () => {
            selectedSeries.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateChart();
        });
        
        document.getElementById('selectMajor').addEventListener('click', () => {
            selectedSeries.clear();
            cesData.series.forEach(s => {
                if (s.level === 'major' || s.level === 'supersector') {
                    selectedSeries.add(s.id);
                }
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedSeries.has(cb.value);
            });
            updateChart();
        });
        
        document.getElementById('expandAll').addEventListener('click', () => {
            document.querySelectorAll('.tree-children').forEach(div => {
                div.classList.add('expanded');
            });
            document.querySelectorAll('.toggle:not(.empty)').forEach(toggle => {
                toggle.innerHTML = '&#9660;'; // Down triangle
            });
        });
        
        document.getElementById('collapseAll').addEventListener('click', () => {
            document.querySelectorAll('.tree-children').forEach(div => {
                div.classList.remove('expanded');
            });
            document.querySelectorAll('.toggle:not(.empty)').forEach(toggle => {
                toggle.innerHTML = '&#9654;'; // Right triangle
            });
        });
        
        // Initialize
        loadData();
    </script>
</body>
</html>