<!DOCTYPE html>
<html>
<head>
    <title>CES Employment Data Viewer - Updated 2025-09-16 21:15</title>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Version: 2025-09-16-21:15 -->
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #F6F7F3;
            color: #3D3733;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 400px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            border-right: 1px solid #DADFCE;
        }

        .main {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        h1 {
            margin: 0 0 15px 0;
            font-size: 22px;
            color: #3D3733;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, button {
            padding: 8px 12px;
            border: 1px solid #DADFCE;
            border-radius: 4px;
            background: white;
            color: #3D3733;
            font-size: 14px;
            cursor: pointer;
        }

        select:hover, button:hover {
            border-color: #67A275;
        }

        button {
            background: #67A275;
            color: white;
            border: none;
            font-weight: 500;
        }

        button:hover {
            background: #5A8F66;
        }

        /* Tree styling */
        .tree-item {
            margin: 2px 0;
            line-height: 1.6;
        }

        .tree-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            color: #3D3733;
            text-transform: none;
            letter-spacing: normal;
        }

        .tree-item label:hover {
            background: rgba(103, 162, 117, 0.1);
        }

        .tree-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .tree-item .name {
            flex: 1;
        }

        .tree-item .value {
            font-size: 12px;
            color: #999;
            margin-left: 10px;
        }

        .tree-item.structural label {
            cursor: default;
            color: #555;
            background: transparent;
        }

        .tree-item.structural label:hover {
            background: none;
        }

        .tree-item.structural input[type="checkbox"] {
            cursor: default;
            opacity: 0.35;
        }

        /* Hierarchy levels */
        .level-total {
            font-weight: bold;
            font-size: 16px;
            background: #0BB4FF;
            color: white;
            margin: 10px 0;
        }

        .level-total .value { color: rgba(255,255,255,0.8); }

        .level-major {
            font-weight: bold;
            background: rgba(11, 180, 255, 0.15);
            margin-left: 15px;
            margin-top: 8px;
        }

        .level-supersector {
            font-weight: 600;
            background: rgba(103, 162, 117, 0.1);
            margin-left: 30px;
            margin-top: 6px;
        }

        .level-sector {
            margin-left: 45px;
            background: rgba(254, 196, 57, 0.08);
        }

        .level-subsector {
            margin-left: 60px;
            font-size: 13px;
        }

        .level-industry_group {
            margin-left: 70px;
            font-size: 12px;
            color: #555;
        }

        .level-industry {
            margin-left: 85px;
            font-size: 12px;
            color: #666;
        }

        #chart {
            flex: 1;
            min-height: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            color: #F4743B;
            padding: 20px;
            background: #FBCAB5;
            border-radius: 4px;
            margin: 20px 0;
        }

        .status {
            font-size: 12px;
            color: #999;
            margin-bottom: 15px;
        }

        .version {
            position: absolute;
            bottom: 10px;
            left: 20px;
            font-size: 10px;
            color: #ccc;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Employment Data</h1>
            <div class="status" id="status">Loading...</div>
            <div id="hierarchy">
                <div class="loading">Loading data...</div>
            </div>
            <div class="version">v2025.09.16.2115</div>
        </div>

        <div class="main">
            <div class="controls">
                <div class="control-group">
                    <label>View</label>
                    <select id="viewType">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="annual">Annual</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Data Type</label>
                    <select id="dataType">
                        <option value="level">Levels</option>
                        <option value="mom" class="monthly-only">Month-over-month change</option>
                        <option value="m3m" class="monthly-only">3-Month Change</option>
                        <option value="yoy" class="monthly-only">Year-over-year change</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Date Range</label>
                    <select id="dateRange">
                        <option value="1">1 year</option>
                        <option value="1.5">18 months</option>
                        <option value="2">2 years</option>
                        <option value="3" selected>3 years</option>
                        <option value="5">5 years</option>
                        <option value="10">10 years</option>
                        <option value="all">All available</option>
                    </select>
                </div>

                <button id="clearAll">Clear All</button>
                <button id="selectMajor">Major Sectors</button>
            </div>

            <div id="chart"></div>
        </div>
    </div>

    <script>
        // Version and cache-busting
        const VERSION = '2025.09.16.2115';
        const CACHE_BUST = Date.now();
        console.log('CES Viewer Version:', VERSION, 'Cache:', CACHE_BUST);

        // Force reload if cached version detected
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        const DATA_URL = window.location.hostname === 'home-economics.us'
            ? `./ces_data.json?v=${CACHE_BUST}&ver=${VERSION}`
            : window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? '../data/ces_data.json?v=' + CACHE_BUST
            : `https://home-economics.us/wp-content/uploads/reports/uploads/CES/ces_data.json?v=${CACHE_BUST}&ver=${VERSION}`;

        // Brand colors
        const COLORS = [
            '#0BB4FF', '#FEC439', '#67A275', '#F4743B',
            '#C6DCCB', '#FBCAB5', '#DADFCE', '#3D3733'
        ];

        const STRUCTURAL_SERIES = {
            'CES4100000001': { name: 'Wholesale trade', parent: 'CES4000000001' },
            'CES4400000001': { name: 'Utilities', parent: 'CES4000000001' }
        };

        // State management
        let cesData = null;
        let seriesById = {};
        let selectedSeries = new Set();
        let currentView = 'monthly';
        let currentDataType = 'level';
        let currentDateRange = 3;

        function inferLevelFromId(seriesId) {
            if (!seriesId) return 'industry';
            if (seriesId === 'CES0000000001') return 'total';
            const majorIds = ['CES0500000001', 'CES0600000001', 'CES0700000001', 'CES0800000001', 'CES9000000001'];
            if (majorIds.includes(seriesId)) {
                return 'major';
            }

            const supersector = seriesId.slice(3, 5);
            const industryCode = seriesId.slice(5, 11);

            if (industryCode === '000000') {
                return 'supersector';
            }

            if (supersector === '20') {
                const sectorPrefixes = ['236', '237', '238'];
                if (sectorPrefixes.includes(industryCode.slice(0, 3)) && industryCode.slice(3) === '000') {
                    return 'sector';
                }

                const subsectorPrefixes = ['2361', '2362', '2371', '2372', '2373', '2379', '2381', '2382', '2383', '2389'];
                if (subsectorPrefixes.includes(industryCode.slice(0, 4))) {
                    return industryCode.slice(4) === '00' ? 'subsector' : 'industry';
                }

                return 'industry';
            }

            if (industryCode.slice(2) === '0000') return 'sector';
            if (industryCode.slice(4) === '00') return 'subsector';
            if (industryCode.slice(5) === '0') return 'industry_group';
            return 'industry';
        }

        function inferOrderFromId(seriesId) {
            if (!seriesId) return 999;

            const specialOrders = {
                'CES0000000001': 0,
                'CES0500000001': 1,
                'CES0600000001': 2,
                'CES0700000001': 3,
                'CES0800000001': 4,
                'CES9000000001': 100
            };

            if (Object.prototype.hasOwnProperty.call(specialOrders, seriesId)) {
                return specialOrders[seriesId];
            }

            const supersector = seriesId.slice(3, 5);
            const industryCode = seriesId.slice(5, 11);

            if (industryCode === '000000' && /^\d+$/.test(supersector)) {
                return parseInt(supersector, 10);
            }

            for (let i = industryCode.length; i > 0; i--) {
                const snippet = industryCode.slice(0, i);
                if (/^\d+$/.test(snippet)) {
                    return parseInt(snippet, 10);
                }
            }

            return 999;
        }

        function addStructuralParents() {
            const missingParents = new Set();

            cesData.series.forEach(series => {
                const parentId = series.parent;
                if (parentId && !seriesById[parentId] && STRUCTURAL_SERIES[parentId]) {
                    missingParents.add(parentId);
                }
            });

            missingParents.forEach(parentId => {
                const info = STRUCTURAL_SERIES[parentId];
                const stub = {
                    id: parentId,
                    name: info.name,
                    level: info.level || inferLevelFromId(parentId),
                    parent: info.parent || null,
                    order: info.order !== undefined ? info.order : inferOrderFromId(parentId),
                    data: null,
                    isStructural: true
                };

                cesData.series.push(stub);
                seriesById[parentId] = stub;
            });
        }

        // Load data on startup
        async function loadData() {
            try {
                // Add cache-busting headers to fetch
                const response = await fetch(DATA_URL, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                if (!response.ok) throw new Error('Failed to load data');

                cesData = await response.json();

                // Create lookup map
                cesData.series.forEach(s => {
                    seriesById[s.id] = s;
                });

                addStructuralParents();

                // Resolve parent relationships against available series
                cesData.series.forEach(series => {
                    series.resolvedParent = resolveParent(series);
                });

                document.getElementById('status').textContent =
                    `${cesData.meta.series_count} series • ${cesData.meta.start_date} to ${cesData.meta.end_date}`;

                buildHierarchy();
                updateChart();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('hierarchy').innerHTML =
                    `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }

        function resolveParent(series) {
            if (!series) return null;

            const directParent = series.parent;
            if (!directParent) {
                return null;
            }

            if (seriesById[directParent]) {
                return directParent;
            }

            const seriesId = series.id || '';
            const supersector = seriesId.slice(3, 5);
            const industry = seriesId.slice(5, 11);
            const dataType = seriesId.slice(11);

            const candidates = [];
            const seen = new Set();

            function addCandidate(id) {
                if (!id || seen.has(id)) return;
                seen.add(id);
                candidates.push(id);
            }

            if (industry) {
                const digits = industry.split('');
                for (let i = digits.length - 1; i >= 0; i--) {
                    if (digits[i] !== '0') {
                        const newIndustry = digits.slice(0, i).join('') + '0'.repeat(digits.length - i);
                        if (newIndustry !== industry) {
                            addCandidate(`CES${supersector}${newIndustry}${dataType}`);
                        }
                    }
                }
            }

            addCandidate(`CES${supersector}000000${dataType}`);

            const supersectorOverrides = {
                '41': 'CES4000000001',
                '42': 'CES4000000001',
                '43': 'CES4000000001',
                '44': 'CES4000000001',
                '48': 'CES4000000001',
                '49': 'CES4000000001',
                '55': 'CES0800000001',
                '60': 'CES0800000001',
                '65': 'CES0800000001',
                '70': 'CES0800000001',
                '80': 'CES0800000001'
            };

            if (supersectorOverrides[supersector]) {
                addCandidate(supersectorOverrides[supersector]);
            }

            const majorOverrides = {
                '10': 'CES0600000001',
                '20': 'CES0600000001',
                '30': 'CES0600000001',
                '31': 'CES3000000001',
                '32': 'CES3000000001'
            };

            if (majorOverrides[supersector]) {
                addCandidate(majorOverrides[supersector]);
            }

            addCandidate('CES0500000001');
            addCandidate('CES0000000001');

            for (const candidate of candidates) {
                if (seriesById[candidate]) {
                    return candidate;
                }
            }

            return null;
        }

        function buildHierarchy() {
            if (!cesData) return;

            const container = document.getElementById('hierarchy');
            container.innerHTML = '';

            // Build tree structure
            const tree = {};
            const roots = [];

            // First pass: identify roots and build parent map
            cesData.series.forEach(series => {
                const parentId = series.resolvedParent;
                if (!parentId) {
                    roots.push(series);
                } else {
                    if (!tree[parentId]) {
                        tree[parentId] = [];
                    }
                    tree[parentId].push(series);
                }
            });

            // Sort roots
            roots.sort((a, b) => (a.order || 999) - (b.order || 999));

            // Recursive function to build tree UI
            function buildTreeNode(series, container) {
                const hasData = series.data && Object.keys(series.data).length > 0;

                const div = document.createElement('div');
                div.className = `tree-item level-${series.level}${hasData ? '' : ' structural'}`;

                const label = document.createElement('label');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = series.id;
                if (hasData) {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedSeries.add(series.id);
                        } else {
                            selectedSeries.delete(series.id);
                        }
                        updateChart();
                    });
                } else {
                    checkbox.disabled = true;
                }

                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.textContent = series.name;

                // Get latest value
                const dates = series.data ? Object.keys(series.data).sort() : [];
                if (dates.length > 0) {
                    const latestValue = series.data[dates[dates.length - 1]];
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'value';
                    valueSpan.textContent = formatNumber(latestValue);
                    label.appendChild(checkbox);
                    label.appendChild(nameSpan);
                    label.appendChild(valueSpan);
                } else {
                    label.appendChild(checkbox);
                    label.appendChild(nameSpan);
                }

                div.appendChild(label);
                container.appendChild(div);

                // Add children
                const children = tree[series.id];
                if (children && children.length > 0) {
                    children.sort((a, b) => (a.order || 999) - (b.order || 999));
                    const childContainer = document.createElement('div');
                    childContainer.className = 'tree-children';
                    div.appendChild(childContainer);
                    children.forEach(child => {
                        buildTreeNode(child, childContainer);
                    });
                }
            }

            // Build the tree starting from roots
            roots.forEach(root => {
                buildTreeNode(root, container);
            });
        }

        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toFixed(0);
        }

        function getFilteredDates() {
            if (!cesData) return [];

            // Get all dates from first series with data
            const seriesWithData = cesData.series.find(s => s.data && Object.keys(s.data).length > 0);
            if (!seriesWithData) return [];

            const allDates = Object.keys(seriesWithData.data).sort();

            if (currentDateRange === 'all') {
                return allDates;
            }

            const cutoffDate = new Date();
            cutoffDate.setFullYear(cutoffDate.getFullYear() - parseFloat(currentDateRange));

            return allDates.filter(date => new Date(date) >= cutoffDate);
        }

        function updateChart() {
            if (!cesData || selectedSeries.size === 0) {
                document.getElementById('chart').innerHTML =
                    '<div class="loading">Select series to display</div>';
                return;
            }

            let filteredDates = getFilteredDates();

            const lastValidDate = filteredDates.reduce((lastDate, date) => {
                const allHaveData = Array.from(selectedSeries).every(seriesId => {
                    const series = seriesById[seriesId];
                    return series && series.data && series.data[date] != null && series.data[date] !== 0;
                });
                return allHaveData ? date : lastDate;
            }, null);

            if (lastValidDate) {
                filteredDates = filteredDates.filter(date => date <= lastValidDate);
            }

            const traces = [];
            const seriesArray = Array.from(selectedSeries);

            seriesArray.forEach((seriesId, index) => {
                const series = seriesById[seriesId];
                if (!series || !series.data) return;

                const values = filteredDates.map(d => series.data[d] || 0);

                let x = filteredDates.slice();
                let y = values.slice();

                if (currentDataType === 'mom') {
                    y = values.map((val, i) => {
                        if (i === 0) return null;
                        const prev = values[i - 1];
                        if (val === 0 || prev === 0) return null;
                        return val - prev;
                    });
                } else if (currentDataType === 'm3m') {
                    y = values.map((val, i) => {
                        if (i < 3) return null;
                        const prev = values[i - 3];
                        if (val === 0 || prev === 0) return null;
                        return val - prev;
                    });
                } else if (currentDataType === 'yoy') {
                    y = values.map((val, i) => {
                        if (i < 12) return null;
                        const prev = values[i - 12];
                        if (val === 0 || prev === 0) return null;
                        return val - prev;
                    });
                }

                if (currentView === 'quarterly') {
                    const quarterData = {};
                    filteredDates.forEach((date, i) => {
                        const val = y[i];
                        if (val === null || val === undefined) return;
                        const year = date.substring(0, 4);
                        const month = parseInt(date.substring(5, 7), 10);
                        const quarter = Math.ceil(month / 3);
                        const key = `${year}-Q${quarter}`;
                        if (!quarterData[key]) quarterData[key] = [];
                        quarterData[key].push(val);
                    });
                    x = Object.keys(quarterData).sort((a, b) => {
                        const [aYear, aQuarter] = a.split('-Q').map(Number);
                        const [bYear, bQuarter] = b.split('-Q').map(Number);
                        return aYear === bYear ? aQuarter - bQuarter : aYear - bYear;
                    });
                    y = x.map(key => {
                        const vals = quarterData[key];
                        return vals.length > 0 ? vals.reduce((sum, v) => sum + v, 0) / vals.length : 0;
                    });
                } else if (currentView === 'annual') {
                    const yearData = {};
                    filteredDates.forEach((date, i) => {
                        const val = y[i];
                        if (val === null || val === undefined) return;
                        const year = date.substring(0, 4);
                        if (!yearData[year]) yearData[year] = [];
                        yearData[year].push(val);
                    });
                    x = Object.keys(yearData).sort();
                    y = x.map(year => {
                        const vals = yearData[year];
                        return vals.length > 0 ? vals.reduce((sum, v) => sum + v, 0) / vals.length : 0;
                    });
                }

                traces.push({
                    x: x,
                    y: y,
                    name: series.name,
                    type: 'bar',
                    marker: { color: COLORS[index % COLORS.length] }
                });
            });

            let yAxisTitle = 'Employment (thousands)';
            if (currentDataType === 'mom') {
                yAxisTitle = 'Month-over-Month Change (thousands)';
            } else if (currentDataType === 'm3m') {
                yAxisTitle = '3-Month Change (thousands)';
            } else if (currentDataType === 'yoy') {
                yAxisTitle = 'Year-over-Year Change (thousands)';
            }

            const layout = {
                barmode: 'stack',
                title: '',
                xaxis: {
                    title: '',
                    tickangle: -45
                },
                yaxis: {
                    title: yAxisTitle,
                    tickformat: ',.0f'
                },
                margin: { t: 40, r: 40, b: 100, l: 80 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: 1.15,
                    x: 0
                },
                paper_bgcolor: 'white',
                plot_bgcolor: 'white'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };

            Plotly.newPlot('chart', traces, layout, config);
        }

        // Event listeners
        document.getElementById('viewType').addEventListener('change', (e) => {
            currentView = e.target.value;
            updateChart();
        });

        document.getElementById('dataType').addEventListener('change', (e) => {
            currentDataType = e.target.value;
            updateChart();
        });

        document.getElementById('dateRange').addEventListener('change', (e) => {
            currentDateRange = e.target.value;
            updateChart();
        });

        document.getElementById('clearAll').addEventListener('click', () => {
            selectedSeries.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateChart();
        });

        document.getElementById('selectMajor').addEventListener('click', () => {
            selectedSeries.clear();
            cesData.series.forEach(s => {
                if ((s.level === 'major' || s.level === 'supersector') && s.data && Object.keys(s.data).length > 0) {
                    selectedSeries.add(s.id);
                }
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedSeries.has(cb.value);
            });
            updateChart();
        });

        // Initialize
        loadData();
    </script>
</body>
</html>